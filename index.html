<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Bill Tracker with Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    select, input {
      width: 200px;
      padding: 5px;
      margin-bottom: 10px;
    }
    #item-list, #bill-details {
      margin-top: 20px;
    }
    #export-button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Customer Bill Tracker with Firebase</h1>

  <label for="customer">Select Customer:</label>
  <select id="customer" onchange="updateItemList()"></select>

  <div id="bill-details">
    <h2>Bill Details for <span id="selected-customer">Kori Prasad</span>:</h2>
    <label for="bill-amount">Bill Amount:</label>
    <input type="number" id="bill-amount" disabled>

    <label for="previous-balance">Previous Balance:</label>
    <input type="number" id="previous-balance" disabled>

    <label for="amount-paid">Amount Paid:</label>
    <input type="number" id="amount-paid" oninput="updateRemainingBalance()">

    <label for="remaining-balance">Remaining Balance:</label>
    <input type="number" id="remaining-balance" disabled>

    <label for="export-button">Export to JPG:</label>
    <button id="export-button" onclick="exportToJpg()">Export</button>
  </div>

  <div id="item-list">
    <h2>Available Items for <span id="selected-customer-items">Kori Prasad</span>:</h2>
    <ul id="items"></ul>
  </div>

  <!-- Add Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.4.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.4.0/firebase-database.js"></script>

  <!-- Add html2canvas library -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <script>
    // Replace with your Firebase config
    var firebaseConfig = {
      apiKey: "AIzaSyA6tSdZQ6d8-5hgeTpYEwvNbW2cqC5Z0aQ",
      authDomain: "mubarak-chicken.firebaseapp.com",
      projectId: "mubarak-chicken",
      storageBucket: "mubarak-chicken.appspot.com",
      messagingSenderId: "160226866721",
      appId: "1:160226866721:web:eb9ff0193554e21739d560"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Get a reference to the database
    var database = firebase.database();

    // Get the customer dropdown element
    var customerDropdown = document.getElementById("customer");

    // Populate the customer dropdown with data from Firebase
    database.ref("customers").once("value")
      .then(function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
          var customerKey = childSnapshot.key;
          var customerName = childSnapshot.val().name;
          var option = document.createElement("option");
          option.value = customerKey;
          option.text = customerName;
          customerDropdown.add(option);
        });

        // Initial update on page load
        updateItemList();
      })
      .catch(function(error) {
        console.error("Error loading customers: " + error);
      });

    function updateItemList() {
      var selectedCustomer = customerDropdown.value;
      document.getElementById("selected-customer").textContent = customerDropdown.options[customerDropdown.selectedIndex].text;

      // Get bill details for the selected customer from Firebase
      database.ref("bills/" + selectedCustomer).once("value")
        .then(function(snapshot) {
          var billDetails = snapshot.val();

          // Update the input fields
          document.getElementById("bill-amount").value = billDetails.billAmount;
          document.getElementById("previous-balance").value = billDetails.previousBalance;
          document.getElementById("amount-paid").value = "";
          document.getElementById("remaining-balance").value = billDetails.remainingBalance;
          
          // Update the item list
          var itemList = document.getElementById("items");
          itemList.innerHTML = "";

          for (var i = 0; i < billDetails.items.length; i++) {
            var listItem = document.createElement("li");
            listItem.textContent = billDetails.items[i];
            itemList.appendChild(listItem);
          }

          // Update the displayed customer name for items
          document.getElementById("selected-customer-items").textContent = customerDropdown.options[customerDropdown.selectedIndex].text;
        })
        .catch(function(error) {
          console.error("Error loading bill details: " + error);
        });
    }

    function updateRemainingBalance() {
      var billAmount = parseFloat(document.getElementById("bill-amount").value) || 0;
      var previousBalance = parseFloat(document.getElementById("previous-balance").value) || 0;
      var amountPaid = parseFloat(document.getElementById("amount-paid").value) || 0;

      // Calculate remaining balance
      var remainingBalance = billAmount + previousBalance - amountPaid;

      // Update the remaining balance field
      document.getElementById("remaining-balance").value = remainingBalance.toFixed(2);
    }

    function exportToJpg() {
      // Get the bill details container element
      var billDetailsContainer = document.getElementById("bill-details");

      // Use html2canvas to capture the bill details container as an image
      html2canvas(billDetailsContainer).then(function(canvas) {
          // Convert the canvas to a data URL
          var dataUrl = canvas.toDataURL("image/jpeg");

          // Create a link element and trigger a download
          var link = document.createElement("a");
          link.href = dataUrl;
          link.download = "bill.jpg";
          link.click();
      });
    }
  </script>

</body>
</html>
